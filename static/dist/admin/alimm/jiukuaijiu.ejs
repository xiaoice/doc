<!doctype html>
<html lang="en">
<head>
    <title>后台</title>
    <script type="application/javascript" src="/js/lib.js"></script>
    <script type="application/javascript" src="/js/jquery.js"></script>
    <script type="application/javascript" src="/plugin/jquery-easyui/jquery.easyui.min.js"></script>
    <script type="application/javascript" src="/plugin/jquery-easyui/datagrid-detailview.js"></script>
    <link charset="utf-8" rel="stylesheet" href="/plugin/jquery-easyui/themes/black/easyui.css" />
    <link charset="utf-8" rel="stylesheet" href="/plugin/jquery-easyui/themes/icon.css" />
    <link charset="utf-8" rel="stylesheet" href="/css/admin.css" />
</head>
<body style="margin: 0;">

    <table id="datagrid" toolbar="#toolbar" pagination="true" idField="id"
           rownumbers="true" fitColumns="true" singleSelect="true">
        <thead>
        <tr>
            <th field="title" width="200">标题</th>
            <th field="reservePrice" width="50">原始价格</th>
            <th field="zkPrice" width="50">销售价格</th>
            <th field="zkRate" width="50">折扣</th>
            <th field="zkType" width="50">折扣类型</th>
            <th field="userType" width="50">来源</th>
            <th field="calCommission" width="50">佣金</th>
            <th field="commissionRatePercent" width="50">佣金比例</th>
            <th field="groupCommission" width="50">群内部佣金</th>
            <th field="groupRate" width="50">群内部佣金比例</th>
            <th field="totalNum" width="50">总推广数</th>
            <th field="totalFee" width="50">总推广金额</th>
        </tr>
        </thead>
    </table>

    <div id="toolbar" style="padding:2px 5px;">
        群组:
        <select id="select_groupId" class="easyui-combobox" panelHeight="auto" style="width:100px">
            <% for(var i=0; i<group.length; i++) {%>
            <option value="<%= group[i].groupId %>"><%= group[i].name %></option>
            <% } %>
        </select>

        排序:
        <select id="select_sort" class="easyui-combobox" panelHeight="auto" style="width:100px">
            <option value="">请选择</option>
            <option value="bid">单价从低到高↑</option>
            <option value="_bid">单价从高到低↓</option>
            <option value="totalnum">销量从低到高↑</option>
            <option value="_totalnum">销量从高到低↓</option>
            <option value="totalfee">佣金从低到高↑</option>
            <option value="_totalfee">佣金从高到低↓</option>
        </select>
        关键字：<input id="input_q" class="textbox-text" type="text"/>
        <a id="bt_search" class="easyui-linkbutton" iconCls="icon-search">搜索</a>
    </div>

    <div id="df" style="display: none;">
        <table width="100%">
            <tr>
                <td>爱淘宝链接:</td>
                <td><input /></td>
                <td>爱淘宝链接:</td>
                <td><input /></td>
            </tr>
        </table>
    </div>
</body>
</html>

<script>
    $(function(){
        var $datagrid=$('#datagrid'),$document=$(document);

        //格式化金额单位
        function formatUtil(val){
            return val+"元";
        }

        //格式化比率
        function formatPercent(val){
            return val+"%";
        }

        //格式化折扣类型
        function formatUserType(val){
            var r={
                0:"<span class='admin-alimm-type-taobao'>淘宝</span>",
                1:"<span class='admin-alimm-type-tmall'>天猫</span>"
            }
            return r[val];
        }

        //格式化商品链接
        function formatAuctionUrl(val){
            return '<a class="admin-alimm-auctionUrl" href="'+val+'" target="_blank">打开</a>';
        }

        //格式化图片
        function formatPicUrl(val){
            return '<img class="admin-alimm-picUrl" src="'+val+'" />';
        }

        //格式化图片
        function formatTitle(val){
            return '<span title="'+val+'" >'+val+'</span>';
        }

        $datagrid.datagrid({
            method:"get"
            ,url: '/admin/alimm/findListByPage.do'
            ,loadMsg:"正在加载，请稍后。。。"
            ,height:$document.height()
            ,queryParams:{
                "groupId":$('#select_groupId').combobox('getValue'),
                "sort":$('#select_sort').combobox('getValue')
            }
            //,pagePosition:"both"
            ,pageSize:40
            ,pageList:[40]
            ,pagination:true
            ,columns:[[
                {field:"auctionId",hidden:true},
                {field:'title',title:'标题',width:'32%',formatter:formatTitle},
                {field:'reservePrice',title:'原始价格',width:'6%',editor:'textbox',formatter:formatUtil},
                {field:'zkRate',title:'折扣',width:'6%',editor:'textbox',formatter:formatPercent},
                {field:'zkType',title:'折扣类型',width:'6%',editor:'textbox'},
                {field:'userType',title:'来源',width:'36px',editor:'textbox',formatter:formatUserType},
                {field:'calCommission',title:'佣金',width:'6%',editor:'textbox',formatter:formatUtil},
                {field:'commissionRatePercent',title:'佣金比例',width:'6%',editor:'textbox',formatter:formatPercent},
                {field:'groupCommission',title:'群内部佣金',width:'6%',editor:'textbox',formatter:formatUtil},
                {field:'groupRate',title:'群内部佣金比例',width:'6%',editor:'textbox',formatter:formatPercent},
                {field:'totalNum',title:'总推广数',width:'6%',editor:'textbox'},
                {field:'totalFee',title:'总推广金额',width:'6%',editor:'textbox',formatter:formatUtil},
                {field:'pictUrl',title:'图',width:'24px',formatter:formatPicUrl},
                {field:'auctionUrl',title:'商品详情',width:'6%',editor:'textbox',formatter:formatAuctionUrl}
            ]]
            ,loadFilter:function(result){
                var data=[],total=0;
                if(result&&result.data){
                    data=result.data.pagelist||[];
                    if(result.data.paginator){
                        total=result.data.paginator.items;
                    }
                }
                return {rows:data,total:total};
            },
            onLoadSuccess: function(result){
                var layout=['first','prev','sep',"links",'sep','next','last','sep','refresh','sep','manual'];
                var displayMsg="当前第[{from}-{to}]条 共[{total}]条";
                $datagrid.datagrid('getPager').pagination({
                    layout:layout,
                    displayMsg:displayMsg
                });
            },
            view: detailview,
            detailFormatter:function(index,row){
                return $("#df").html();
            },
            onExpandRow: function(index,row){
                var ddv = $(this).datagrid('getRowDetail',index).find('div.ddv');
                $datagrid.datagrid('fixDetailRowHeight',index);
            },
            onRowContextMenu:function(e,index,row){
                $("#admin-alimm-picBox").remove();
                $('<div id="admin-alimm-picBox" class="admin-alimm-picBox"><img src="'+row.pictUrl+'"/></div>').appendTo("body");
                e.preventDefault();
            }
        });

        //点击搜索按钮
        $document.on("click","#bt_search",function(){
            var groupId=$('#select_groupId').combobox('getValue')
                ,sort=$('#select_sort').combobox('getValue')
                ,q=$('#input_q').val();
            if(!groupId){
                return alert("请选择群组");
            }
            $datagrid.datagrid("reload",{
                "groupId":groupId,
                "sort":sort,
                "q":q
            });
        });

        $document.on("mouseenter",".admin-alimm-picUrl",function(){
            var $this=$(this),url=$(this).attr("src"),left=$this.offset().left,top=$this.offset().top;
            $("#admin-alimm-picBox").remove();
            $('<div id="admin-alimm-picBox" class="admin-alimm-picBox"><img src="'+url+'"/></div>').appendTo("body");
        }).on("click",".admin-alimm-picBox",function(){
            $(this).remove();
        }).on("mouseleave",".admin-alimm-picUrl",function(){
            $("#admin-alimm-picBox").remove();
        });

        $document.on("keyup","#input_q",function(e){
            if(e.keyCode===13){
                $("#bt_search").trigger("click");
            }
        });



    });
</script>